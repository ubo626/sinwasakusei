<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¥è©±SNS å®Œå…¨ç‰ˆ</title>
<style>
body { font-family: Arial; max-width: 800px; margin:auto; padding:20px; background:#fff; color:#333; }
h1 { text-align:center; border-bottom:2px solid #eee; padding-bottom:10px; }
form, .post, .modal { border:1px solid #eee; border-radius:8px; padding:15px; margin:15px 0; background:#fafafa; }
input, textarea { width:100%; padding:8px; margin:8px 0; border:1px solid #ccc; border-radius:5px; }
button { background:#333; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; }
button:hover { background:#555; }
.verified { color:#0078ff; font-weight:bold; }
.like { color:#e74c3c; cursor:pointer; display:inline-block; margin-right:10px; }
.modal { display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%); width:90%; max-width:500px; background:#fff; z-index:1000; }
.modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#00000088; z-index:900; }
</style>
</head>
<body>
<h1>ç¥è©±SNS å®Œå…¨ç‰ˆ</h1>

<div id="authSection">
  <h2 id="authTitle">åˆã‚ã¦ã®æ–¹ã¯è‡ªå‹•IDã§æ–°è¦ç™»éŒ² / æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ­ã‚°ã‚¤ãƒ³</h2>
  <div id="idDisplay"></div>
  <input type="text" id="userIdInput" placeholder="ID">
  <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <button id="authBtn">ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³</button>
</div>

<div id="mainSection" style="display:none;">
  <p id="userInfo"></p>
  <form id="postForm">
    <input type="text" id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" required>
    <textarea id="content" placeholder="ç¥è©±ã®å†…å®¹" required></textarea>
    <input type="text" id="tags" placeholder="ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰">
    <label><input type="checkbox" id="adminVerify"> ç®¡ç†è€…èªå®šãƒãƒ¼ã‚¯</label>
    <button type="submit">æŠ•ç¨¿</button>
  </form>

  <h2>æŠ•ç¨¿ä¸€è¦§</h2>
  <button id="sortNew">ğŸ•“ æ–°ç€é †</button>
  <button id="sortLike">â¤ï¸ ã„ã„ã­é †</button>
  <div id="postList"></div>
</div>

<div class="modal-overlay" id="modalOverlay"></div>
<div class="modal" id="postModal">
  <h3 id="modalTitle"></h3>
  <p id="modalContent"></p>
  <p id="modalAuthor"></p>
  <p id="modalTags"></p>
  <p class="like" id="modalLike"></p>
  <button id="modalEditBtn" style="display:none;">ç·¨é›†</button>
  <button onclick="closeModal()">é–‰ã˜ã‚‹</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDoc, setDoc, doc, updateDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
Â  apiKey: "AIzaSyD18XhUujCSo_ezYyf_rV8crnjBz7Pv1jY",
Â  authDomain: "sinwasakusei.firebaseapp.com",
Â  projectId: "sinwasakusei",
Â  storageBucket: "sinwasakusei.firebasestorage.app",
Â  messagingSenderId: "135038486513",
Â  appId: "1:135038486513:web:1791f88ca12571560ba650",
Â  measurementId: "G-CRQ4R3MTNX"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentUser = null;
let sortByLikes = false;

// ===== è‡ªå‹•IDç”Ÿæˆ =====
function generateId() {
  return 'U' + Math.random().toString(36).substr(2, 6).toUpperCase();
}

const storedId = localStorage.getItem("userId") || generateId();
localStorage.setItem("userId", storedId);
document.getElementById("idDisplay").innerText = `ã‚ãªãŸã®è‡ªå‹•ID: ${storedId}`;
document.getElementById("userIdInput").value = storedId;

// ===== ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³ =====
document.getElementById("authBtn").onclick = async () => {
  const id = document.getElementById("userIdInput").value;
  const pass = document.getElementById("passwordInput").value;
  if(!id || !pass) return alert("IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const userRef = doc(db,"users",id);
  const userSnap = await getDoc(userRef);

  if(!userSnap.exists()) {
    // æ–°è¦ç™»éŒ²
    await setDoc(userRef,{ password:pass, isAdmin:false });
    currentUser={id, password:pass, isAdmin:false};
    alert(`ID ${id} ã§æ–°è¦ç™»éŒ²ã•ã‚Œã¾ã—ãŸ`);
  } else {
    const data = userSnap.data();
    if(data.password!==pass) return alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
    currentUser={id, password:pass, isAdmin:data.isAdmin||false};
    alert(`ID ${id} ã§ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ`);
  }

  document.getElementById("authSection").style.display="none";
  document.getElementById("mainSection").style.display="block";
  document.getElementById("userInfo").innerText=`ãƒ­ã‚°ã‚¤ãƒ³ID: ${currentUser.id} ${currentUser.isAdmin?'(ç®¡ç†è€…)': ''}`;
  loadPosts();
};

// ===== æŠ•ç¨¿ =====
document.getElementById("postForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const title=document.getElementById("title").value;
  const content=document.getElementById("content").value;
  const tags=document.getElementById("tags").value.split(",").map(t=>t.trim());
  const verified=document.getElementById("adminVerify").checked && currentUser.isAdmin;

  await addDoc(collection(db,"myths"),{
    title, content, tags,
    authorId:currentUser.id,
    verified,
    likes:[],
    createdAt:new Date()
  });
  e.target.reset();
  loadPosts();
});

// ===== æŠ•ç¨¿ä¸€è¦§ =====
async function loadPosts(){
  const postList=document.getElementById("postList");
  postList.innerHTML="";
  const q=query(collection(db,"myths"),orderBy(sortByLikes?"likes":"createdAt","desc"));
  const snapshot=await getDocs(q);
  snapshot.forEach(docSnap=>{
    const data=docSnap.data();
    const div=document.createElement("div");
    div.classList.add("post");
    div.innerHTML=`<h3 class="postTitle">${data.title} ${data.verified?'<span class="verified">âœ”èªå®š</span>':''}</h3>
                   <p>æŠ•ç¨¿è€…: ${data.authorId}</p>
                   <p class="like" onclick="toggleLike('${docSnap.id}')">â¤ï¸ ${data.likes.length}</p>`;
    div.onclick=()=>openModal(docSnap.id,data);
    postList.appendChild(div);
  });
}

// ä¸¦ã¹æ›¿ãˆ
document.getElementById("sortNew").onclick=()=>{ sortByLikes=false; loadPosts(); };
document.getElementById("sortLike").onclick=()=>{ sortByLikes=true; loadPosts(); };

// ===== ã„ã„ã­æ©Ÿèƒ½ =====
window.toggleLike=async(postId)=>{
  const postRef=doc(db,"myths",postId);
  const postSnap=await getDoc(postRef);
  if(!postSnap.exists()) return;
  const data=postSnap.data();
  const likes=data.likes||[];
  if(likes.includes(currentUser.id)) likes.splice(likes.indexOf(currentUser.id),1);
  else likes.push(currentUser.id);
  await updateDoc(postRef,{likes});
  loadPosts();
};

// ===== æŠ•ç¨¿è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« =====
const modal=document.getElementById("postModal");
const overlay=document.getElementById("modalOverlay");
window.openModal=(id,data)=>{
  modal.style.display="block";
  overlay.style.display="block";
  document.getElementById("modalTitle").innerText=data.title;
  document.getElementById("modalContent").innerText=data.content;
  document.getElementById("modalAuthor").innerText="æŠ•ç¨¿è€…: "+data.authorId;
  document.getElementById("modalTags").innerText="ã‚¿ã‚°: "+data.tags.join(", ");
  const likeElem=document.getElementById("modalLike");
  const liked=data.likes.includes(currentUser.id);
  likeElem.innerText=`â¤ï¸ ${data.likes.length}`;
  likeElem.onclick=()=>toggleLike(id);

  const editBtn=document.getElementById("modalEditBtn");
  if(data.authorId===currentUser.id){
    editBtn.style.display="inline-block";
    editBtn.onclick=async()=>{
      const newContent=prompt("æ–°ã—ã„æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:",data.content);
      if(!newContent) return;
      await updateDoc(doc(db,"myths",id),{content:newContent});
      loadPosts();
      closeModal();
    };
  } else editBtn.style.display="none";
};
window.closeModal=()=>{ modal.style.display="none"; overlay.style.display="none"; };
</script>
</body>
</html>